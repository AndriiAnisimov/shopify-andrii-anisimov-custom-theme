{% comment %}
  Featured Products Section with Sorting and Add to Cart
  Uses Section Rendering API and Fetch
{% endcomment %}

<section class="featured-products-section py-10 md:py-16" data-section-id="{{ section.id }}">
    <div class="container mx-auto px-4">
        {% if section.settings.title != blank %}
            <h2 class="text-2xl md:text-3xl font-semibold mb-6 md:mb-8 text-center text-gray-900">
                {{ section.settings.title }}
            </h2>
        {% endif %}

        <div class="featured-products__sort flex justify-end mb-5 md:mb-8 items-center gap-2">
            <label for="sort-by" class="text-sm md:text-base font-medium text-gray-700">
                {{ 'products.sort_by' | t | default: 'Сортувати:' }}
            </label>
            <select
                    id="sort-by"
                    name="sort_by"
                    class="border border-gray-300 rounded-md px-2 py-1 text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-black bg-white"
            >
                <option value="best-selling">Популярні</option>
                <option value="price-ascending">Ціна: від низької до високої</option>
                <option value="price-descending">Ціна: від високої до низької</option>
                <option value="title-ascending">Назва: A–Z</option>
            </select>
        </div>

        <div class="products-grid grid gap-5 md:gap-6 grid-cols-[repeat(auto-fit,minmax(200px,1fr))]">
            {%- assign collection = collections[section.settings.collection] -%}
            {%- if collection != blank and collection.products_count > 0 -%}
                {%- assign sorted_products = collection.products -%}
                {%- for product in sorted_products limit: section.settings.products_count -%}
                    <div class="product-card border border-gray-300 p-4 md:p-5 text-center rounded-lg hover:shadow-md transition-shadow duration-200">
                        <a href="{{ product.url }}" class="product-card__image block mb-3 md:mb-4">
                            {{ product.featured_image | image_url: width: 400 | image_tag: alt: product.title, class: "w-full h-auto object-cover rounded-md" }}
                        </a>
                        <h3 class="product-card__title text-base md:text-lg font-medium mb-2 md:mb-3 text-gray-800">
                            {{ product.title }}
                        </h3>

                        {% if section.settings.show_price %}
                            <p class="product-card__price text-gray-900 font-semibold mb-2">
                                {{ product.price | money }}
                            </p>
                        {% endif %}

                        {% if section.settings.show_rating %}
                            <div class="product-card__rating text-yellow-500 text-sm mb-2" aria-label="{{ 'a11y.rating' | t }}">
                                ⭐⭐⭐⭐☆
                            </div>
                        {% endif %}

                        {% if section.settings.show_add_to_cart %}
                            <button
                                    class="product-card__add bg-black text-white border-none px-3 py-2 md:px-4 md:py-2.5 cursor-pointer mt-2 hover:bg-gray-800 rounded-md transition-colors duration-200"
                                    data-product-id="{{ product.id }}"
                                    data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                            >
                                {{ 'Додати в кошик' }}
                            </button>
                        {% endif %}
                    </div>
                {%- endfor -%}
            {%- else -%}
                <p class="text-center text-gray-500">{{ 'teaser.empty' | t }}</p>
            {%- endif -%}
        </div>
    </div>
</section>

{% schema %}
{
  "name": "Featured Products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Заголовок",
      "default": "Обрані товари"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Колекція"
    },
    {
      "type": "range",
      "id": "products_count",
      "label": "Кількість товарів",
      "min": 2,
      "max": 12,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_price",
      "label": "Показувати ціну",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Показувати рейтинг",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "label": "Кнопка 'Додати в кошик'",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Обрані товари"
    }
  ]
}
{% endschema %}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const section = document.querySelector('[data-section-id="{{ section.id }}"]');
        const sortSelect = section.querySelector('#sort-by');

        sortSelect.addEventListener('change', async (e) => {
            const sort = e.target.value;
            const url = `${window.location.pathname}?section_id={{ section.id }}&sort_by=${sort}`;

            try {
                const res = await fetch(url);
                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const newSection = doc.querySelector('[data-section-id="{{ section.id }}"]');
                section.replaceWith(newSection);
            } catch (err) {
                console.error('Помилка сортування:', err);
            }
        });

        document.body.addEventListener('click', async (e) => {
            const btn = e.target.closest('.product-card__add');
            if (!btn) return;

            e.preventDefault();
            const variantId = btn.dataset.variantId;
            btn.disabled = true;
            btn.textContent = 'Додається...';

            try {
                const res = await fetch('/cart/add.js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: variantId, quantity: 1 })
                });
                if (!res.ok) throw new Error('Помилка додавання');

                btn.textContent = 'Додано!';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'Додати в кошик';
                }, 1500);

                await updateMiniCart();
            } catch (err) {
                console.error('Add to cart error:', err);
                btn.textContent = 'Помилка';
                btn.disabled = false;
            }
        });

        async function updateMiniCart() {
            try {
                const res = await fetch('/?section_id=cart-drawer');
                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const newCart = doc.querySelector('[data-section-id="cart-drawer"]');
                const oldCart = document.querySelector('[data-section-id="cart-drawer"]');

                if (newCart && oldCart) {
                    oldCart.replaceWith(newCart);
                }
            } catch (err) {
                console.error('Mini cart update failed:', err);
            }
        }
    });
</script>
