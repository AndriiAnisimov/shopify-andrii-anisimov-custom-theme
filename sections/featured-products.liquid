{% comment %}
  Featured Products Section with Sorting and Add to Cart
  Uses Section Rendering API and Fetch
{% endcomment %}

<section class="featured-products-section" data-section-id="{{ section.id }}">
    <div class="container">
        {% if section.settings.title != blank %}
            <h2>{{ section.settings.title }}</h2>
        {% endif %}

        <!-- Sorting Dropdown -->
        <div class="featured-products__sort">
            <label for="sort-by">{{ 'products.sort_by' | t | default: 'Сортувати:' }}</label>
            <select id="sort-by" name="sort_by">
                <option value="best-selling">Популярні</option>
                <option value="price-ascending">Ціна: від низької до високої</option>
                <option value="price-descending">Ціна: від високої до низької</option>
                <option value="title-ascending">Назва: A–Z</option>
            </select>
        </div>

        <div class="products-grid">
            {%- assign collection = collections[section.settings.collection] -%}
            {%- if collection != blank and collection.products_count > 0 -%}
                {%- assign sorted_products = collection.products -%}
                {%- for product in sorted_products limit: section.settings.products_count -%}
                    <div class="product-card">
                        <a href="{{ product.url }}" class="product-card__image">
                            {{ product.featured_image | image_url: width: 400 | image_tag: alt: product.title }}
                        </a>
                        <h3 class="product-card__title">{{ product.title }}</h3>

                        {% if section.settings.show_price %}
                            <p class="product-card__price">{{ product.price | money }}</p>
                        {% endif %}

                        {% if section.settings.show_rating %}
                            <div class="product-card__rating" aria-label="{{ 'a11y.rating' | t }}">
                                ⭐⭐⭐⭐☆
                            </div>
                        {% endif %}

                        {% if section.settings.show_add_to_cart %}
                            <button
                                    class="product-card__add"
                                    data-product-id="{{ product.id }}"
                                    data-variant-id="{{ product.first_available_variant.id }}"
                            >
                                {{ 'products.product.add_to_cart' | t | default: 'Додати в кошик' }}
                            </button>
                        {% endif %}
                    </div>
                {%- endfor -%}
            {%- else -%}
                <p>{{ 'teaser.empty' | t }}</p>
            {%- endif -%}
        </div>
    </div>
</section>

{% schema %}
{
  "name": "Featured Products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Заголовок",
      "default": "Обрані товари"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Колекція"
    },
    {
      "type": "range",
      "id": "products_count",
      "label": "Кількість товарів",
      "min": 2,
      "max": 12,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_price",
      "label": "Показувати ціну",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Показувати рейтинг",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "label": "Кнопка 'Додати в кошик'",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Обрані товари"
    }
  ]
}
{% endschema %}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const section = document.querySelector('[data-section-id="{{ section.id }}"]');
        const sortSelect = section.querySelector('#sort-by');

        // --- 1. Зміна сортування ---
        sortSelect.addEventListener('change', async (e) => {
            const sort = e.target.value;
            const url = `${window.location.pathname}?section_id={{ section.id }}&sort_by=${sort}`;

            try {
                const res = await fetch(url);
                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const newSection = doc.querySelector('[data-section-id="{{ section.id }}"]');
                section.replaceWith(newSection);
            } catch (err) {
                console.error('Помилка сортування:', err);
            }
        });

        // --- 2. Add to Cart ---
        document.body.addEventListener('click', async (e) => {
            const btn = e.target.closest('.product-card__add');
            if (!btn) return;

            e.preventDefault();
            const variantId = btn.dataset.variantId;
            btn.disabled = true;
            btn.textContent = 'Додається...';

            try {
                // Додаємо товар
                const res = await fetch('/cart/add.js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: variantId, quantity: 1 })
                });
                if (!res.ok) throw new Error('Помилка додавання');

                btn.textContent = 'Додано!';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'Додати в кошик';
                }, 1500);

                await updateMiniCart();
            } catch (err) {
                console.error('Add to cart error:', err);
                btn.textContent = 'Помилка';
                btn.disabled = false;
            }
        });

        // --- 3. Оновлення міні-кошика ---
        async function updateMiniCart() {
            try {
                const res = await fetch('/?section_id=cart-drawer');
                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const newCart = doc.querySelector('[data-section-id="cart-drawer"]');
                const oldCart = document.querySelector('[data-section-id="cart-drawer"]');

                if (newCart && oldCart) {
                    oldCart.replaceWith(newCart);
                }
            } catch (err) {
                console.error('Mini cart update failed:', err);
            }
        }
    });
</script>
